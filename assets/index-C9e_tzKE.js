import{V as w,E as Et,c as Ct,a as vt,k as St,d as J,n as Mt,s as Tt,W as Ft,t as Rt,A as Lt,u as At,v as It,M as rt,O as W,f as tt,L as Bt,w as zt,g as et,x as at,y as Dt,z as Ot,G as Ht,H as jt,J as _t,D as Nt}from"./three-core-DfqISRBQ.js";import{O as Vt,R as kt,T as ct}from"./three-extras-CG5jZg23.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();const gt=Math.PI*2,Ut={circle:12,rectangle:12,square:12,triangle:12};function lt(o,t){const e={id:o,type:t,position:new w,rotation:new Et,scale:new w(1,1,1),radius:1,width:2,height:1.4,boundarySamples:64,controlPoints:[]};return e.controlPoints=Wt(e,Ut[t]),e}function yt(o,t,e=new w){return o.controlPoints&&o.controlPoints.length>=4?Xt(o.controlPoints,t,e):bt(o,t,e)}function ot(o,t=o.boundarySamples){const e=[];for(let n=0;n<t;n+=1)e.push(yt(o,n/t));return e}function Wt(o,t){const e=Math.max(4,t),n=[];for(let s=0;s<e;s+=1)n.push(bt(o,s/e,new w));return n}function bt(o,t,e){const n=(t%1+1)%1;if(o.type==="circle"){const s=n*gt;return e.set(Math.cos(s)*o.radius,Math.sin(s)*o.radius,0)}return o.type==="square"?ht(o.width,o.width,n,e):o.type==="triangle"?Gt(o.width,o.height,n,e):ht(o.width,o.height,n,e)}function Gt(o,t,e,n){const s=o*.5,a=t*.5,r=0,c=a,i=-s,d=-a,l=s,h=-a,u=Math.hypot(i-r,d-c),m=Math.hypot(l-i,h-d),f=Math.hypot(r-l,c-h),b=u+m+f;let g=e*b;if(g<=u){const y=u<=1e-8?0:g/u;return n.set(r+(i-r)*y,c+(d-c)*y,0)}if(g-=u,g<=m){const y=m<=1e-8?0:g/m;return n.set(i+(l-i)*y,d+(h-d)*y,0)}g-=m;const p=f<=1e-8?0:g/f;return n.set(l+(r-l)*p,h+(c-h)*p,0)}function Xt(o,t,e){const n=o.length,a=(t%1+1)%1*n,r=Math.floor(a)%n,c=a-Math.floor(a),i=o[(r-1+n)%n],d=o[r],l=o[(r+1)%n],h=o[(r+2)%n],u=c*c,m=u*c,f=.5*(2*d.x+(-i.x+l.x)*c+(2*i.x-5*d.x+4*l.x-h.x)*u+(-i.x+3*d.x-3*l.x+h.x)*m),b=.5*(2*d.y+(-i.y+l.y)*c+(2*i.y-5*d.y+4*l.y-h.y)*u+(-i.y+3*d.y-3*l.y+h.y)*m),g=.5*(2*d.z+(-i.z+l.z)*c+(2*i.z-5*d.z+4*l.z-h.z)*u+(-i.z+3*d.z-3*l.z+h.z)*m);return e.set(f,b,g)}function ht(o,t,e,n){const s=o*.5,a=t*.5,r=Math.min(Math.min(o,t)*.18,s,a),c=o-2*r,i=t-2*r,d=2*(c+i)+gt*r;let l=e*d;const h=[c,Math.PI*.5*r,i,Math.PI*.5*r,c,Math.PI*.5*r,i,Math.PI*.5*r];for(let u=0;u<h.length;u+=1){const m=h[u];if(l<=m+1e-8)return qt(u,l,s,a,r,n);l-=m}return n.set(s-r,a,0)}function qt(o,t,e,n,s,a){const r=e,c=n,i=s;if(o===0)return a.set(-r+i+t,c,0);if(o===1){const l=Math.PI*.5-t/i;return a.set(r-i+Math.cos(l)*i,c-i+Math.sin(l)*i,0)}if(o===2)return a.set(r,c-i-t,0);if(o===3){const l=-t/i;return a.set(r-i+Math.cos(l)*i,-c+i+Math.sin(l)*i,0)}if(o===4)return a.set(r-i-t,-c,0);if(o===5){const l=-Math.PI*.5-t/i;return a.set(-r+i+Math.cos(l)*i,-c+i+Math.sin(l)*i,0)}if(o===6)return a.set(-r,-c+i+t,0);const d=Math.PI-t/i;return a.set(-r+i+Math.cos(d)*i,c-i+Math.sin(d)*i,0)}function Yt(o,t){if(o.length<=1)return[];const e=[];for(let i=0;i<o.length;i+=1)for(let d=i+1;d<o.length;d+=1){const l=t.get(o[i]),h=t.get(o[d]);!l||!h||e.push({aIndex:i,bIndex:d,weight:l.distanceTo(h)})}e.sort((i,d)=>i.weight-d.weight);const n=o.map((i,d)=>d),s=o.map(()=>0),a=i=>(n[i]!==i&&(n[i]=a(n[i])),n[i]),r=(i,d)=>{const l=a(i),h=a(d);return l===h?!1:(s[l]<s[h]?n[l]=h:s[l]>s[h]?n[h]=l:(n[h]=l,s[l]+=1),!0)},c=[];for(const i of e)if(r(i.aIndex,i.bIndex)&&(c.push({from:o[i.aIndex],to:o[i.bIndex],weight:i.weight}),c.length===o.length-1))break;return c}function Qt(o,t={}){if(o.length<2)return{positions:new Float32Array,indices:new Uint32Array,boundaryConstraints:[],sampleCount:0,mstEdgeCount:0};const e=Math.max(2,t.spanSubdivisions??24),n=Math.max(8,Math.min(...o.map(m=>m.state.boundarySamples))),s=[],a=[],r=[],c=new Map,i=new Map,d=new Map,l=m=>(s.push(m.x,m.y,m.z),s.length/3-1);for(const m of o){m.object.updateMatrixWorld(!0);const f=m.object.matrixWorld,g=ot(m.state,n).map(y=>y.clone().applyMatrix4(f));c.set(m.id,g);const p=[];for(let y=0;y<n;y+=1){const x=l(g[y]);p.push(x),r.push({vertexIndex:x,frameId:m.id,curveParamT:y/n})}i.set(m.id,p),d.set(m.id,new w().setFromMatrixPosition(f))}const h=o.map(m=>m.id),u=Yt(h,d);for(const m of u){const f=c.get(m.from),b=c.get(m.to),g=i.get(m.from),p=i.get(m.to);if(!f||!b||!g||!p)continue;const y=Zt(f,b),x=Array.from({length:n},()=>new Array(e+1).fill(-1));for(let P=0;P<n;P+=1){const v=xt(P,n,y);x[P][0]=g[P],x[P][e]=p[v];for(let E=1;E<e;E+=1){const S=E/e,M=f[P].clone().lerp(b[v],S);x[P][E]=l(M)}}for(let P=0;P<n;P+=1){const v=(P+1)%n;for(let E=0;E<e;E+=1){const S=x[P][E],M=x[v][E],L=x[v][E+1],D=x[P][E+1];a.push(S,M,L),a.push(S,L,D)}}}return{positions:new Float32Array(s),indices:new Uint32Array(a),boundaryConstraints:r,sampleCount:n,mstEdgeCount:u.length}}function Zt(o,t){const e=o.length,n=[!1,!0];let s={reverse:!1,shift:0},a=Number.POSITIVE_INFINITY;for(const r of n)for(let c=0;c<e;c+=1){let i=0;for(let d=0;d<e;d+=1){const l=xt(d,e,{reverse:r,shift:c});i+=o[d].distanceToSquared(t[l])}i<a&&(a=i,s={reverse:r,shift:c})}return s}function xt(o,t,e){return e.reverse?((e.shift-o)%t+t)%t:(o+e.shift)%t}const Kt={substeps:4,stepSize:.14,damping:.92,laplacianWeight:.2,relaxationStrength:1,shapeRetention:0,stiffness:0},Pt=1e-8;function $t(o,t={}){return{positions:o.positions.slice(),velocities:new Float32Array(o.positions.length),indices:o.indices,boundaryConstraints:o.boundaryConstraints,restPositions:o.positions.slice(),solverConfig:{...Kt,...t}}}function Jt(o){const t=o.positions.length/3,e=Array.from({length:t},()=>new Set);for(let r=0;r<o.indices.length;r+=3){const c=o.indices[r],i=o.indices[r+1],d=o.indices[r+2];e[c].add(i),e[c].add(d),e[i].add(c),e[i].add(d),e[d].add(c),e[d].add(i)}const n=new Uint8Array(t);for(const r of o.boundaryConstraints)n[r.vertexIndex]=1;const s=e.map(r=>Array.from(r)),a=s.map((r,c)=>{const i=c*3,d=o.restPositions[i],l=o.restPositions[i+1],h=o.restPositions[i+2];return r.map(u=>{const m=u*3,f=o.restPositions[m],b=o.restPositions[m+1],g=o.restPositions[m+2],p=f-d,y=b-l,x=g-h;return Math.sqrt(p*p+y*y+x*x)})});return{boundaryMask:n,neighbors:s,neighborRestLengths:a,gradient:new Float32Array(o.positions.length),scratchPositions:new Float32Array(o.positions.length),scratchVelocities:new Float32Array(o.velocities.length)}}function dt(o,t,e,n={}){if(o.indices.length===0)return 0;const{substeps:s,stepSize:a,damping:r,laplacianWeight:c,relaxationStrength:i,shapeRetention:d,stiffness:l}=o.solverConfig,h=Math.max(0,i),u=Math.max(0,d),m=Math.max(0,l);for(let f=0;f<s;f+=1){mt(o,e),t.gradient.fill(0),ne(o,t.gradient),t.scratchPositions.set(o.positions),t.scratchVelocities.set(o.velocities);const b=o.positions.length/3;for(let g=0;g<b;g+=1){if(t.boundaryMask[g]===1)continue;const p=g*3,y=o.positions[p],x=o.positions[p+1],P=o.positions[p+2],v=o.restPositions[p],E=o.restPositions[p+1],S=o.restPositions[p+2],M=t.gradient[p],L=t.gradient[p+1],D=t.gradient[p+2];let A=0,O=0,I=0;const C=t.neighbors[g];if(C.length>0){for(const z of C){const R=z*3;A+=o.positions[R],O+=o.positions[R+1],I+=o.positions[R+2]}const B=1/C.length;A=A*B-y,O=O*B-x,I=I*B-P}let T=0,F=0,H=0;if(m>0&&C.length>0){const B=t.neighborRestLengths[g];for(let R=0;R<C.length;R+=1){const U=C[R]*3,j=o.positions[U]-y,_=o.positions[U+1]-x,N=o.positions[U+2]-P,Q=j*j+_*_+N*N;if(Q<Pt)continue;const Z=Math.sqrt(Q),$=(Z-B[R])/Z;T+=j*$,F+=_*$,H+=N*$}const z=1/C.length;T*=z,F*=z,H*=z}const G=(-M+c*A)*h+(v-y)*u+T*m,X=(-L+c*O)*h+(E-x)*u+F*m,K=(-D+c*I)*h+(S-P)*u+H*m,q=o.velocities[p]*r+G*a,Y=o.velocities[p+1]*r+X*a,k=o.velocities[p+2]*r+K*a;t.scratchVelocities[p]=q,t.scratchVelocities[p+1]=Y,t.scratchVelocities[p+2]=k,t.scratchPositions[p]=y+q*a,t.scratchPositions[p+1]=x+Y*a,t.scratchPositions[p+2]=P+k*a}o.positions.set(t.scratchPositions),o.velocities.set(t.scratchVelocities),mt(o,e)}return n.computeSurfaceArea===!1?Number.NaN:ee(o.positions,o.indices)}function te(o){o.positions.set(o.restPositions),o.velocities.fill(0)}function ee(o,t){let e=0;for(let n=0;n<t.length;n+=3){const s=t[n]*3,a=t[n+1]*3,r=t[n+2]*3,c=o[s],i=o[s+1],d=o[s+2],l=o[a],h=o[a+1],u=o[a+2],m=o[r],f=o[r+1],b=o[r+2],g=l-c,p=h-i,y=u-d,x=m-c,P=f-i,v=b-d,E=p*v-y*P,S=y*x-g*v,M=g*P-p*x;e+=.5*Math.sqrt(E*E+S*S+M*M)}return e}function mt(o,t){for(const e of o.boundaryConstraints){const n=t(e);if(!n)continue;const s=e.vertexIndex*3;o.positions[s]=n.x,o.positions[s+1]=n.y,o.positions[s+2]=n.z,o.velocities[s]=0,o.velocities[s+1]=0,o.velocities[s+2]=0}}function ne(o,t){const e=o.positions;for(let n=0;n<o.indices.length;n+=3){const s=o.indices[n],a=o.indices[n+1],r=o.indices[n+2],c=s*3,i=a*3,d=r*3,l=e[c],h=e[c+1],u=e[c+2],m=e[i],f=e[i+1],b=e[i+2],g=e[d],p=e[d+1],y=e[d+2],x=m-l,P=f-h,v=b-u,E=g-l,S=p-h,M=y-u,L=P*M-v*S,D=v*E-x*M,A=x*S-P*E,O=Math.sqrt(L*L+D*D+A*A);if(O<Pt)continue;const I=1/O,C=L*I,T=D*I,F=A*I,H=m-g,G=f-p,X=b-y,K=.5*(G*F-X*T),q=.5*(X*C-H*F),Y=.5*(H*T-G*C),k=g-l,B=p-h,z=y-u,R=.5*(B*F-z*T),st=.5*(z*C-k*F),U=.5*(k*T-B*C),j=l-m,_=h-f,N=u-b,Q=.5*(_*F-N*T),Z=.5*(N*C-j*F),it=.5*(j*T-_*C);t[c]+=K,t[c+1]+=q,t[c+2]+=Y,t[i]+=R,t[i+1]+=st,t[i+2]+=U,t[d]+=Q,t[d+1]+=Z,t[d+2]+=it}}const ut=[[-2.2,1.2,0],[2.2,1.2,0],[0,2.2,2],[0,.8,-2],[-2,1.8,-2],[2,.8,2]],ft={fast:{substeps:2,stepSize:.16,damping:.91,laplacianWeight:.2,relaxationStrength:1,shapeRetention:0,stiffness:.35,normalsUpdateInterval:4},balanced:{substeps:4,stepSize:.14,damping:.92,laplacianWeight:.2,relaxationStrength:1,shapeRetention:0,stiffness:.35,normalsUpdateInterval:2},high:{substeps:6,stepSize:.13,damping:.93,laplacianWeight:.22,relaxationStrength:1,shapeRetention:0,stiffness:.35,normalsUpdateInterval:1}},oe=3,se=24,ie=.82,re=.9,ae=1.2,ce=1.35,le=3,he=.1,de=4,V=1e-4,me=1.25,ue=.4,pt=2/3,nt=.04,fe=3067903,pe=16777215;class ge{canvas;renderer;scene;camera;orbitControls;transformControls;transformControlHelpers;controlPointTransformControl;controlPointTransformHelper;uiElements;raycaster=new Ct;pointer=new vt;boundarySampleScratch=new w;worldScaleScratch=new w;uiCleanupCallbacks=[];uiRangeBindings=[];controlPointGeometry=new St(1,14,10);controlPointMaterial=new J({color:fe});controlPointSelectedMaterial=new J({color:pe});frameEntities=new Map;frameSelectable=new Set;controlPointSelectable=new Set;selectedFrameId=null;pointEditFrameId=null;selectedControlPoint=null;frameClipboard=null;frameIdCounter=0;filmRuntime=null;environmentRenderTarget=null;uiState={solverQuality:"balanced",solverSpeed:1,relaxationStrength:1,shapeRetention:0,stiffness:.35,showWireframe:!1};isTransformDragging=!1;isUsingTransformControls=!1;geometryUpdateCounter=0;lastAnimationTimeSeconds=performance.now()*.001;animationFrameHandle=0;onResizeBound;onPointerDownBound;onDoubleClickBound;onKeyDownBound;constructor(t){this.canvas=t,this.scene=new Mt,this.scene.background=new Tt(0),this.renderer=new Ft({canvas:this.canvas,antialias:!0}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.outputColorSpace=Rt,this.renderer.toneMapping=Lt,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=At,this.camera=new It(55,window.innerWidth/window.innerHeight,.1,300),this.camera.position.set(8,5.5,8),this.orbitControls=new Vt(this.camera,this.renderer.domElement),this.orbitControls.enableDamping=!0,this.orbitControls.dampingFactor=.08,this.orbitControls.mouseButtons.LEFT=void 0,this.orbitControls.mouseButtons.MIDDLE=rt.PAN,this.orbitControls.mouseButtons.RIGHT=rt.ROTATE;const e=this.createTransformControl("translate",1),n=this.createTransformControl("rotate",.5),s=this.createTransformControl("scale",.42);this.transformControls=[e.control,n.control,s.control],this.transformControlHelpers=[e.helper,n.helper,s.helper];const a=this.createControlPointTransformControl(.8);this.controlPointTransformControl=a.control,this.controlPointTransformHelper=a.helper,this.raycaster.params.Line={threshold:.2},this.setupSceneHelpers(),this.setupEnvironment(),this.uiElements=this.resolveUiElements(),this.setupUi(),this.onResizeBound=()=>this.handleResize(),this.onPointerDownBound=r=>this.handlePointerDown(r),this.onDoubleClickBound=r=>this.handleDoubleClick(r),this.onKeyDownBound=r=>this.handleKeyDown(r),window.addEventListener("resize",this.onResizeBound),this.canvas.addEventListener("pointerdown",this.onPointerDownBound),this.canvas.addEventListener("dblclick",this.onDoubleClickBound),window.addEventListener("keydown",this.onKeyDownBound),this.animationLoop()}addFrame(t){const e=`frame-${++this.frameIdCounter}`,n=lt(e,t);t==="circle"?n.radius=1:t==="rectangle"?(n.width=2,n.height=1.4):t==="square"?(n.width=2,n.height=2):(n.width=2,n.height=1.8);const s=ut[this.frameEntities.size%ut.length];return n.position.set(s[0],s[1],s[2]),n.rotation.set(0,this.frameEntities.size*Math.PI/8,0),this.addFrameFromState(n)}addFrameFromState(t){const e=this.createFrameEntity(t);return this.frameEntities.set(t.id,e),this.frameSelectable.add(e.line),this.selectFrame(t.id),this.rebuildFilm(),t.id}createFrameEntity(t){const e=new W;e.position.copy(t.position),e.rotation.copy(t.rotation);const n=new W;n.scale.set(Math.max(V,Math.abs(t.scale.x)),Math.max(V,Math.abs(t.scale.y)),Math.max(V,Math.abs(t.scale.z)));const s=new W;s.scale.set(this.getScaleSign(t.scale.x),this.getScaleSign(t.scale.y),this.getScaleSign(t.scale.z));const a=new tt().setFromPoints(ot(t,t.boundarySamples)),r=new Bt({color:16777215}),c=new zt(a,r);c.userData.frameId=t.id,c.renderOrder=5;const i=new W;i.visible=!1;const d=[];for(let l=0;l<t.controlPoints.length;l+=1){const h=new W;h.position.copy(t.controlPoints[l]);const u=new et(this.controlPointGeometry,this.controlPointMaterial);u.userData.frameId=t.id,u.userData.controlPointIndex=l,u.renderOrder=6,h.add(u),i.add(h),d.push({index:l,object:h,mesh:u}),this.controlPointSelectable.add(u)}return e.add(n),n.add(s),s.add(c),s.add(i),this.scene.add(e),{id:t.id,state:t,object:s,transformObject:e,scaleProxy:n,line:c,material:r,controlPointGroup:i,controlPoints:d}}removeFrame(t){const e=this.frameEntities.get(t);if(e){this.pointEditFrameId===t&&this.exitPointEditMode(),this.selectedFrameId===t&&this.selectFrame(null),this.frameSelectable.delete(e.line);for(const n of e.controlPoints)this.controlPointSelectable.delete(n.mesh);e.line.geometry.dispose(),e.material.dispose(),e.object.remove(e.line),e.object.remove(e.controlPointGroup),e.scaleProxy.remove(e.object),e.transformObject.remove(e.scaleProxy),this.scene.remove(e.transformObject),this.frameEntities.delete(t),this.rebuildFilm()}}selectFrame(t){if(this.selectedFrameId!==t){this.pointEditFrameId&&this.pointEditFrameId!==t&&this.exitPointEditMode(),this.selectedFrameId=t;for(const[e,n]of this.frameEntities)n.material.color.setHex(e===t?65535:16777215);this.updateControlPointVisibility(),this.updateFrameTransformControlAttachments()}}resetSimulation(){this.filmRuntime&&(te(this.filmRuntime.state),this.geometryUpdateCounter=0,this.refreshFilmGeometry(!0))}rebuildFilm(){this.syncFrameStatesFromObjects(),this.updateFrameWorldMatrices(),this.disposeFilmRuntime();const t=Array.from(this.frameEntities.values()),e=Qt(t,{spanSubdivisions:24});if(e.indices.length===0)return;const n=this.getActiveSolverConfig(),s=$t(e,n),a=Jt(s),r=new tt,c=new at(s.positions,3);c.setUsage(Dt),r.setAttribute("position",c),r.setIndex(new at(s.indices,1)),r.computeVertexNormals();const{material:i,oilTimeUniform:d}=this.createSoapFilmMaterial(),l=new et(r,i);l.castShadow=!1,l.receiveShadow=!0,l.renderOrder=1;const h=new J({color:2120959,wireframe:!0,transparent:!0,opacity:.7,depthTest:!1}),u=new et(r,h);u.visible=this.uiState.showWireframe,u.renderOrder=2,this.scene.add(l),this.scene.add(u),this.filmRuntime={state:s,solverContext:a,geometry:r,mesh:l,wireframeMesh:u,material:i,wireframeMaterial:h,oilTimeUniform:d},dt(this.filmRuntime.state,this.filmRuntime.solverContext,m=>this.sampleConstraintPoint(m),{computeSurfaceArea:!1}),this.geometryUpdateCounter=0,this.refreshFilmGeometry(!0)}dispose(){cancelAnimationFrame(this.animationFrameHandle),window.removeEventListener("resize",this.onResizeBound),this.canvas.removeEventListener("pointerdown",this.onPointerDownBound),this.canvas.removeEventListener("dblclick",this.onDoubleClickBound),window.removeEventListener("keydown",this.onKeyDownBound);for(const t of this.uiCleanupCallbacks)t();this.uiCleanupCallbacks.length=0;for(const t of this.transformControlHelpers)this.scene.remove(t);for(const t of this.transformControls)t.dispose();this.scene.remove(this.controlPointTransformHelper),this.controlPointTransformControl.dispose(),this.orbitControls.dispose();for(const t of this.frameEntities.values())t.line.geometry.dispose(),t.material.dispose(),t.object.remove(t.controlPointGroup),t.object.remove(t.line),t.scaleProxy.remove(t.object),t.transformObject.remove(t.scaleProxy),this.scene.remove(t.transformObject);this.frameEntities.clear(),this.frameSelectable.clear(),this.controlPointSelectable.clear(),this.disposeFilmRuntime(),this.environmentRenderTarget&&(this.environmentRenderTarget.dispose(),this.environmentRenderTarget=null),this.controlPointGeometry.dispose(),this.controlPointMaterial.dispose(),this.controlPointSelectedMaterial.dispose(),this.renderer.dispose()}setupSceneHelpers(){const t=new Ot(16777215,.55);this.scene.add(t);const e=new Ht(16777215,1.15);e.position.set(8,10,4),this.scene.add(e)}setupEnvironment(){const t=new jt(this.renderer),e=new kt;this.environmentRenderTarget=t.fromScene(e,me),this.scene.environment=this.environmentRenderTarget.texture,e.dispose(),t.dispose()}resolveUiElements(){const t=document.getElementById("ui-panel"),e=document.getElementById("ui-handle"),n=document.getElementById("ui-handle-bottom"),s=document.getElementById("collapse-toggle"),a=document.getElementById("add-circle"),r=document.getElementById("add-rectangle"),c=document.getElementById("add-square"),i=document.getElementById("add-triangle"),d=document.getElementById("reset-solver"),l=document.getElementById("solver-quality"),h=document.getElementById("solver-speed"),u=document.getElementById("solver-speed-value"),m=document.getElementById("relaxation-strength"),f=document.getElementById("relaxation-strength-value"),b=document.getElementById("shape-retention"),g=document.getElementById("shape-retention-value"),p=document.getElementById("stiffness"),y=document.getElementById("stiffness-value"),x=document.getElementById("show-wireframe");if(!(t instanceof HTMLDivElement)||!(e instanceof HTMLDivElement)||!(n instanceof HTMLDivElement)||!(s instanceof HTMLButtonElement)||!(a instanceof HTMLButtonElement)||!(r instanceof HTMLButtonElement)||!(c instanceof HTMLButtonElement)||!(i instanceof HTMLButtonElement)||!(d instanceof HTMLButtonElement)||!(l instanceof HTMLSelectElement)||!(h instanceof HTMLInputElement)||!(u instanceof HTMLSpanElement)||!(m instanceof HTMLInputElement)||!(f instanceof HTMLSpanElement)||!(b instanceof HTMLInputElement)||!(g instanceof HTMLSpanElement)||!(p instanceof HTMLInputElement)||!(y instanceof HTMLSpanElement)||!(x instanceof HTMLInputElement))throw new Error("UI elements for controls panel are missing or invalid.");return{panel:t,handleTop:e,handleBottom:n,collapseToggle:s,addCircleButton:a,addRectangleButton:r,addSquareButton:c,addTriangleButton:i,resetSolverButton:d,solverQualitySelect:l,solverSpeedRange:h,solverSpeedValue:u,relaxationStrengthRange:m,relaxationStrengthValue:f,shapeRetentionRange:b,shapeRetentionValue:g,stiffnessRange:p,stiffnessValue:y,wireframeToggle:x}}setupUi(){this.uiElements.solverQualitySelect.value=this.uiState.solverQuality,this.uiElements.wireframeToggle.checked=this.uiState.showWireframe,this.bindRangeControl({input:this.uiElements.solverSpeedRange,value:this.uiElements.solverSpeedValue,format:t=>t.toFixed(2)},t=>{this.uiState.solverSpeed=t,this.filmRuntime&&this.applySolverQualityConfig()},this.uiState.solverSpeed),this.bindRangeControl({input:this.uiElements.relaxationStrengthRange,value:this.uiElements.relaxationStrengthValue,format:t=>t.toFixed(2)},t=>{this.uiState.relaxationStrength=t,this.filmRuntime&&this.applySolverQualityConfig()},this.uiState.relaxationStrength),this.bindRangeControl({input:this.uiElements.shapeRetentionRange,value:this.uiElements.shapeRetentionValue,format:t=>t.toFixed(2)},t=>{this.uiState.shapeRetention=t,this.filmRuntime&&this.applySolverQualityConfig()},this.uiState.shapeRetention),this.bindRangeControl({input:this.uiElements.stiffnessRange,value:this.uiElements.stiffnessValue,format:t=>t.toFixed(2)},t=>{this.uiState.stiffness=t,this.filmRuntime&&this.applySolverQualityConfig()},this.uiState.stiffness),this.addDomListener(this.uiElements.addCircleButton,"click",()=>this.addFrame("circle")),this.addDomListener(this.uiElements.addRectangleButton,"click",()=>this.addFrame("rectangle")),this.addDomListener(this.uiElements.addSquareButton,"click",()=>this.addFrame("square")),this.addDomListener(this.uiElements.addTriangleButton,"click",()=>this.addFrame("triangle")),this.addDomListener(this.uiElements.resetSolverButton,"click",()=>this.rebuildFilm()),this.addDomListener(this.uiElements.solverQualitySelect,"change",()=>{const t=this.uiElements.solverQualitySelect.value;(t==="fast"||t==="balanced"||t==="high")&&(this.uiState.solverQuality=t,this.filmRuntime&&this.applySolverQualityConfig())}),this.addDomListener(this.uiElements.wireframeToggle,"change",()=>{this.uiState.showWireframe=this.uiElements.wireframeToggle.checked,this.filmRuntime&&(this.filmRuntime.wireframeMesh.visible=this.uiState.showWireframe)}),this.setupUiPanelInteractions(),this.refreshAllRangeProgress()}setupUiPanelInteractions(){const{panel:t,handleTop:e,handleBottom:n,collapseToggle:s}=this.uiElements;let a=null;this.addDomListener(s,"pointerdown",h=>{h.stopPropagation()}),this.addDomListener(s,"click",()=>{const h=t.classList.toggle("is-collapsed");s.setAttribute("aria-expanded",h?"false":"true"),this.clampPanelToViewport(),requestAnimationFrame(()=>this.refreshAllRangeProgress())});const r=t.querySelectorAll(".panel-section .panel-heading");for(const h of r)this.addDomListener(h,"click",()=>{const u=h.closest(".panel-section");if(!u)return;const m=u.classList.toggle("is-collapsed");h.setAttribute("aria-expanded",m?"false":"true"),this.clampPanelToViewport(),requestAnimationFrame(()=>this.refreshAllRangeProgress())});const c=h=>{const u=h,m=u.target;if(m instanceof Element&&m.closest(".collapse-button"))return;const f=u.currentTarget;f instanceof Element&&("setPointerCapture"in f&&f.setPointerCapture(u.pointerId),a={x:u.clientX-t.offsetLeft,y:u.clientY-t.offsetTop})},i=h=>{const u=h;if(!a)return;const m=10,f=Math.max(m,Math.min(window.innerWidth-t.offsetWidth-m,u.clientX-a.x)),b=Math.max(m,u.clientY-a.y);t.style.left=`${f}px`,t.style.top=`${b}px`,this.clampPanelToViewport()},d=()=>{a=null},l=[e,n];for(const h of l)this.addDomListener(h,"pointerdown",c),this.addDomListener(h,"pointermove",i),this.addDomListener(h,"pointerup",d),this.addDomListener(h,"pointercancel",d);this.clampPanelToViewport()}bindRangeControl(t,e,n){this.uiRangeBindings.push(t),t.input.value=String(n);const s=()=>{const a=Number(t.input.value);t.value.textContent=t.format(a),this.setRangeProgress(t.input),e(a)};this.addDomListener(t.input,"input",s),s()}setRangeProgress(t){const e=Number(t.min),n=Number(t.max),s=Number(t.value),a=n-e,r=a<=0?0:(s-e)/a,c=16,i=t.clientWidth||1,d=Math.max(i-c,1),l=r*d+c*.5;t.style.setProperty("--range-progress",`${l}px`)}refreshAllRangeProgress(){for(const t of this.uiRangeBindings)this.setRangeProgress(t.input)}clampPanelToViewport(){const{panel:t,handleTop:e,handleBottom:n}=this.uiElements,s=10,a=e.offsetHeight+n.offsetHeight+40,r=Math.max(s,window.innerHeight-a-s),c=Math.min(Math.max(t.offsetTop,s),r);c!==t.offsetTop&&(t.style.top=`${c}px`);const i=window.innerHeight-c-s;t.style.maxHeight=`${Math.max(i,a)}px`;const d=Math.max(s,window.innerWidth-t.offsetWidth-s),l=Math.min(Math.max(t.offsetLeft,s),d);l!==t.offsetLeft&&(t.style.left=`${l}px`)}addDomListener(t,e,n,s){t.addEventListener(e,n,s),this.uiCleanupCallbacks.push(()=>{t.removeEventListener(e,n,s)})}handleResize(){const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.clampPanelToViewport(),this.refreshAllRangeProgress()}handlePointerDown(t){if(t.button!==0||this.isUsingTransformControls||this.isTransformDragging)return;if(this.updatePointerFromEvent(t),this.raycaster.setFromCamera(this.pointer,this.camera),this.pointEditFrameId){const r=this.raycaster.intersectObjects(Array.from(this.controlPointSelectable),!1).find(c=>c.object.userData.frameId===this.pointEditFrameId);if(r){const c=r.object.userData.frameId,i=r.object.userData.controlPointIndex;if(c&&typeof i=="number"){this.selectControlPoint(c,i);return}}}const e=this.raycaster.intersectObjects(Array.from(this.frameSelectable));if(e.length===0){this.exitPointEditMode(),this.selectFrame(null);return}const s=e[0].object.userData.frameId;if(!s){this.exitPointEditMode(),this.selectFrame(null);return}this.selectFrame(s),this.pointEditFrameId===s&&this.selectControlPoint(null)}handleDoubleClick(t){if(t.button!==0||this.isUsingTransformControls||this.isTransformDragging)return;this.updatePointerFromEvent(t),this.raycaster.setFromCamera(this.pointer,this.camera);const e=this.raycaster.intersectObjects(Array.from(this.frameSelectable));if(e.length===0){this.exitPointEditMode();return}const n=e[0].object.userData.frameId;if(!n){this.exitPointEditMode();return}this.selectFrame(n),this.pointEditFrameId===n?this.exitPointEditMode():this.enterPointEditMode(n)}handleKeyDown(t){const e=t.ctrlKey||t.metaKey;if(e){const n=t.key.toLowerCase();if(n==="c"){this.copySelectedFrame(),t.preventDefault();return}if(n==="v"){this.pasteFrameFromClipboard(),t.preventDefault();return}}!e&&t.key==="Escape"&&(this.pointEditFrameId?this.exitPointEditMode():this.selectFrame(null),t.preventDefault()),!e&&t.key==="Delete"&&this.selectedFrameId&&this.removeFrame(this.selectedFrameId)}updatePointerFromEvent(t){const e=this.canvas.getBoundingClientRect();this.pointer.x=(t.clientX-e.left)/e.width*2-1,this.pointer.y=-((t.clientY-e.top)/e.height)*2+1}enterPointEditMode(t){const e=this.frameEntities.get(t);!e||e.controlPoints.length===0||(this.pointEditFrameId=t,this.updateControlPointVisibility(),this.updateFrameTransformControlAttachments(),this.selectControlPoint(t,0))}exitPointEditMode(){!this.pointEditFrameId&&!this.selectedControlPoint||(this.pointEditFrameId=null,this.selectControlPoint(null),this.updateControlPointVisibility(),this.updateFrameTransformControlAttachments())}updateControlPointVisibility(){for(const[t,e]of this.frameEntities)e.controlPointGroup.visible=this.pointEditFrameId===t}updateFrameTransformControlAttachments(){for(const a of this.transformControls)a.detach();if(!this.selectedFrameId||this.pointEditFrameId===this.selectedFrameId)return;const t=this.frameEntities.get(this.selectedFrameId);if(!t)return;const[e,n,s]=this.transformControls;e?.attach(t.transformObject),n?.attach(t.transformObject),s?.attach(t.scaleProxy)}selectControlPoint(t,e=-1){if(!t||e<0){this.selectedControlPoint=null,this.controlPointTransformControl.detach(),this.refreshControlPointVisuals();return}const n=this.frameEntities.get(t);if(!n){this.selectedControlPoint=null,this.controlPointTransformControl.detach(),this.refreshControlPointVisuals();return}const s=n.controlPoints[e];s&&(this.selectedControlPoint={frameId:t,controlPointIndex:e},this.controlPointTransformControl.attach(s.object),this.refreshControlPointVisuals())}refreshControlPointVisuals(){for(const[t,e]of this.frameEntities)for(const n of e.controlPoints){const s=this.selectedControlPoint?.frameId===t&&this.selectedControlPoint.controlPointIndex===n.index;n.mesh.material=s?this.controlPointSelectedMaterial:this.controlPointMaterial}}syncFrameControlPointsFromHandles(t){t.state.controlPoints.length!==t.controlPoints.length&&(t.state.controlPoints=t.controlPoints.map(()=>new w));for(const e of t.controlPoints)t.state.controlPoints[e.index].copy(e.object.position)}refreshFrameLineGeometry(t){const e=ot(t.state,t.state.boundarySamples),n=t.line.geometry,s=n.getAttribute("position");if(!s||s.count!==e.length){t.line.geometry.dispose(),t.line.geometry=new tt().setFromPoints(e),t.line.computeLineDistances?.();return}for(let a=0;a<e.length;a+=1){const r=e[a];s.setXYZ(a,r.x,r.y,r.z)}s.needsUpdate=!0,n.computeBoundingSphere()}copySelectedFrame(){if(!this.selectedFrameId)return;const t=this.frameEntities.get(this.selectedFrameId);t&&(t.state.position.copy(t.transformObject.position),t.state.rotation.copy(t.transformObject.rotation),this.copyFrameScaleFromNodes(t,t.state.scale),this.syncFrameControlPointsFromHandles(t),this.frameClipboard={type:t.state.type,radius:t.state.radius,width:t.state.width,height:t.state.height,boundarySamples:t.state.boundarySamples,controlPoints:t.state.controlPoints.map(e=>[e.x,e.y,e.z]),position:[t.state.position.x,t.state.position.y,t.state.position.z],rotation:[t.state.rotation.x,t.state.rotation.y,t.state.rotation.z],scale:[t.state.scale.x,t.state.scale.y,t.state.scale.z]})}pasteFrameFromClipboard(){if(!this.frameClipboard)return;const t=`frame-${++this.frameIdCounter}`,e=lt(t,this.frameClipboard.type);e.radius=this.frameClipboard.radius,e.width=this.frameClipboard.width,e.height=this.frameClipboard.height,e.boundarySamples=this.frameClipboard.boundarySamples,e.controlPoints=this.frameClipboard.controlPoints.map(n=>new w(n[0],n[1],n[2])),e.position.set(this.frameClipboard.position[0]+.5,this.frameClipboard.position[1],this.frameClipboard.position[2]+.5),e.rotation.set(this.frameClipboard.rotation[0],this.frameClipboard.rotation[1],this.frameClipboard.rotation[2]),e.scale.set(this.frameClipboard.scale[0],this.frameClipboard.scale[1],this.frameClipboard.scale[2]),this.addFrameFromState(e)}animationLoop=()=>{this.animationFrameHandle=requestAnimationFrame(this.animationLoop);const t=performance.now()*.001,e=Math.min(.05,Math.max(.001,t-this.lastAnimationTimeSeconds));if(this.lastAnimationTimeSeconds=t,this.orbitControls.update(),this.updateFrameWorldMatrices(),this.updateControlPointHandleScales(),this.filmRuntime){this.filmRuntime.oilTimeUniform.value+=e,this.applySolverQualityConfig();const n=ft[this.uiState.solverQuality];dt(this.filmRuntime.state,this.filmRuntime.solverContext,r=>this.sampleConstraintPoint(r),{computeSurfaceArea:!1}),this.geometryUpdateCounter+=1;const s=this.isTransformDragging?1:n.normalsUpdateInterval,a=this.geometryUpdateCounter%s===0;this.refreshFilmGeometry(a)}this.renderer.render(this.scene,this.camera)};updateControlPointHandleScales(){for(const t of this.frameEntities.values()){t.object.getWorldScale(this.worldScaleScratch);const e=Math.max(1e-4,Math.abs(this.worldScaleScratch.x)),n=Math.max(1e-4,Math.abs(this.worldScaleScratch.y)),s=Math.max(1e-4,Math.abs(this.worldScaleScratch.z));for(const a of t.controlPoints)a.mesh.scale.set(nt/e,nt/n,nt/s)}}refreshFilmGeometry(t){if(!this.filmRuntime)return;const e=this.filmRuntime.geometry.getAttribute("position");e.needsUpdate=!0,t&&(this.filmRuntime.geometry.computeVertexNormals(),this.filmRuntime.geometry.computeBoundingSphere())}sampleConstraintPoint(t){const e=this.frameEntities.get(t.frameId);return e?yt(e.state,t.curveParamT,this.boundarySampleScratch).applyMatrix4(e.object.matrixWorld):null}updateFrameWorldMatrices(){for(const t of this.frameEntities.values())t.transformObject.updateMatrixWorld(!0)}getActiveSolverConfig(){const t=ft[this.uiState.solverQuality],e=Math.min(de,Math.max(he,this.uiState.solverSpeed));let n=Math.max(1,Math.round(t.substeps*e)),s=t.stepSize,a=t.damping,r=t.laplacianWeight,c=Math.min(2,Math.max(.05,this.uiState.relaxationStrength));const i=Math.min(.5,Math.max(0,this.uiState.shapeRetention)),d=Math.min(10,Math.max(0,this.uiState.stiffness));return this.isTransformDragging&&(n=Math.min(se,Math.max(t.substeps+2,t.substeps*oe)),s=t.stepSize*re,a=Math.min(t.damping,ie),r=t.laplacianWeight*ae,c=Math.min(le,Math.max(.05,c*ce))),{substeps:n,stepSize:s,damping:a,laplacianWeight:r,relaxationStrength:c,shapeRetention:i,stiffness:d}}applySolverQualityConfig(){this.filmRuntime&&(this.filmRuntime.state.solverConfig=this.getActiveSolverConfig())}syncFrameStatesFromObjects(){for(const t of this.frameEntities.values())t.state.position.copy(t.transformObject.position),t.state.rotation.copy(t.transformObject.rotation),this.copyFrameScaleFromNodes(t,t.state.scale),this.syncFrameControlPointsFromHandles(t)}disposeFilmRuntime(){this.filmRuntime&&(this.scene.remove(this.filmRuntime.mesh),this.scene.remove(this.filmRuntime.wireframeMesh),this.filmRuntime.geometry.dispose(),this.filmRuntime.material.dispose(),this.filmRuntime.wireframeMaterial.dispose(),this.filmRuntime=null)}createControlPointTransformControl(t){const e=new ct(this.camera,this.renderer.domElement);e.setMode("translate"),e.setSpace("local"),e.setSize(t),e.addEventListener("dragging-changed",()=>{e.dragging?this.setExclusiveTransformControl(e):this.setExclusiveTransformControl(null),this.updateTransformDraggingState()}),e.addEventListener("mouseDown",()=>{this.getTransformControlAxis(e)&&(this.setExclusiveTransformControl(e),this.isUsingTransformControls=!0)}),e.addEventListener("mouseUp",()=>{window.setTimeout(()=>{this.isUsingTransformControls=!1,this.setExclusiveTransformControl(null)},0)}),e.addEventListener("objectChange",()=>{this.handleControlPointObjectChange()}),this.stripNonAxisTransformHandles(e,"translate"),this.stripTranslateBackArrows(e),this.resizeTranslateArrowHeads(e,pt);const n=e.getHelper();return this.scene.add(n),{control:e,helper:n}}createTransformControl(t,e){const n=new ct(this.camera,this.renderer.domElement);n.setMode(t),n.setSpace("local"),n.setSize(e),n.addEventListener("dragging-changed",()=>{n.dragging?this.setExclusiveTransformControl(n):this.setExclusiveTransformControl(null),this.updateTransformDraggingState()}),n.addEventListener("mouseDown",()=>{this.getTransformControlAxis(n)&&(this.setExclusiveTransformControl(n),this.isUsingTransformControls=!0)}),n.addEventListener("mouseUp",()=>{window.setTimeout(()=>{this.isUsingTransformControls=!1,this.setExclusiveTransformControl(null)},0)}),t==="scale"&&n.addEventListener("objectChange",()=>{this.handleScaleProxyObjectChange()});const s=n.getHelper();return this.stripNonAxisTransformHandles(n,t),t==="translate"&&(this.stripTranslateBackArrows(n),this.resizeTranslateArrowHeads(n,pt)),t==="scale"&&this.pushBackScaleHandles(n,ue),this.scene.add(s),{control:n,helper:s}}handleControlPointObjectChange(){if(!this.selectedControlPoint)return;const t=this.frameEntities.get(this.selectedControlPoint.frameId);if(!t)return;const e=t.controlPoints[this.selectedControlPoint.controlPointIndex];e&&(t.state.controlPoints[e.index].copy(e.object.position),this.refreshFrameLineGeometry(t))}handleScaleProxyObjectChange(){if(!this.selectedFrameId)return;const t=this.frameEntities.get(this.selectedFrameId);t&&t.scaleProxy.scale.set(Math.max(V,Math.abs(t.scaleProxy.scale.x)),Math.max(V,Math.abs(t.scaleProxy.scale.y)),Math.max(V,Math.abs(t.scaleProxy.scale.z)))}updateTransformDraggingState(){const t=this.isTransformDragging,e=this.controlPointTransformControl.dragging||this.transformControls.some(n=>n.dragging);this.isTransformDragging=e,this.orbitControls.enabled=!e,!t&&e&&this.filmRuntime&&this.filmRuntime.state.velocities.fill(0)}getTransformControlAxis(t){const e=t.axis;return typeof e=="string"?e:null}setExclusiveTransformControl(t){const e=[...this.transformControls,this.controlPointTransformControl];for(const n of e)n.enabled=!t||n===t}getScaleSign(t){return t<0?-1:1}copyFrameScaleFromNodes(t,e){e.set(t.scaleProxy.scale.x*t.object.scale.x,t.scaleProxy.scale.y*t.object.scale.y,t.scaleProxy.scale.z*t.object.scale.z)}stripNonAxisTransformHandles(t,e){const n=new Set(e==="scale"?["X","Y","Z","XYZ"]:["X","Y","Z"]),a=t._gizmo;if(!a)return;const r=a.helper?.[e];if(r)for(const i of[...r.children])r.remove(i);const c=[a.gizmo?.[e],a.picker?.[e]];for(const i of c){if(!i)continue;const d=i.children.filter(l=>!n.has(l.name));for(const l of d)i.remove(l)}}stripTranslateBackArrows(t){const e={X:new w(1,0,0),Y:new w(0,1,0),Z:new w(0,0,1)},s=t._gizmo;if(!s)return;const a=[s.gizmo?.translate,s.picker?.translate];for(const r of a)if(r)for(const c of["X","Y","Z"]){const i=r.children.filter(h=>h.name===c);if(i.length<=1)continue;const d=e[c],l=[];for(const h of i){const m=h.geometry;if(!m)continue;m.computeBoundingBox();const f=m.boundingBox;if(!f)continue;f.getCenter(new w).dot(d)<-1e-4&&l.push(h)}for(const h of l)r.remove(h)}}resizeTranslateArrowHeads(t,e){const n={X:new w(1,0,0),Y:new w(0,1,0),Z:new w(0,0,1)},a=t._gizmo?.gizmo?.translate;if(a)for(const r of["X","Y","Z"]){const c=n[r];for(const i of a.children){if(i.name!==r)continue;const l=i.geometry;if(!l)continue;l.computeBoundingBox();const h=l.boundingBox;if(!h)continue;const u=h.getCenter(new w),m=h.getSize(new w),f=Math.max(m.x,m.y,m.z),b=Math.min(m.x,m.y,m.z);if(!(u.dot(c)>.35&&f<=.16&&b>.03))continue;const y=u.clone().multiplyScalar(-1);l.translate(y.x,y.y,y.z),l.scale(e,e,e),l.translate(u.x,u.y,u.z)}}}pushBackScaleHandles(t,e){const n={X:new w(1,0,0),Y:new w(0,1,0),Z:new w(0,0,1)},a=t._gizmo;if(!a)return;const r=a.gizmo?.scale;if(r)for(const i of["X","Y","Z"]){const d=n[i],l=[];for(const h of r.children){if(h.name!==i)continue;const m=h.geometry;if(!m)continue;m.computeBoundingBox();const f=m.boundingBox;if(!f)continue;const b=f.getSize(new w);if(Math.max(b.x,b.y,b.z)>.2)continue;const y=f.getCenter(new w).dot(d);y>1e-4?l.push(h):y<-1e-4&&m.translate(-d.x*e,-d.y*e,-d.z*e)}for(const h of l)r.remove(h)}const c=a.picker?.scale;if(c)for(const i of["X","Y","Z"]){const d=n[i],l=[];for(const h of c.children){if(h.name!==i)continue;const m=h.geometry;if(!m)continue;m.computeBoundingBox();const f=m.boundingBox;if(!f)continue;const g=f.getCenter(new w).dot(d);g>1e-4?l.push(h):g<-1e-4&&m.translate(-d.x*e,-d.y*e,-d.z*e)}for(const h of l)c.remove(h)}}createSoapFilmMaterial(){const t=new _t({color:14017784,transparent:!0,opacity:.39,transmission:1,thickness:.018,ior:1.33,roughness:.035,metalness:0,envMapIntensity:.92,iridescence:1,iridescenceIOR:1.45,iridescenceThicknessRange:[80,1200],side:Nt,clearcoat:.75,clearcoatRoughness:.06}),e={value:0};return t.onBeforeCompile=n=>{n.uniforms.uOilTime=e,n.vertexShader=`
varying vec3 vSoapWorldPos;
`+n.vertexShader,n.vertexShader=n.vertexShader.replace("#include <worldpos_vertex>",`
#include <worldpos_vertex>
vSoapWorldPos = worldPosition.xyz;
`),n.fragmentShader=`
uniform float uOilTime;
varying vec3 vSoapWorldPos;

vec3 soapSpectrum(float t) {
  return clamp(abs(mod(t * 6.0 + vec3(0.0, 4.0, 2.0), 6.0) - 3.0) - 1.0, 0.0, 1.0);
}
`+n.fragmentShader,n.fragmentShader=n.fragmentShader.replace("#include <opaque_fragment>",`
#include <opaque_fragment>
vec3 soapViewDir = normalize(vViewPosition);
float soapFresnel = pow(1.0 - clamp(dot(normalize(normal), soapViewDir), 0.0, 1.0), 2.25);
float soapSwirlA = sin(vSoapWorldPos.x * 0.55 + vSoapWorldPos.y * 0.4 - vSoapWorldPos.z * 0.48 + uOilTime * 0.08) * 0.5 + 0.5;
float soapSwirlB = sin((vSoapWorldPos.x + vSoapWorldPos.y + vSoapWorldPos.z) * 0.95 - uOilTime * 0.055) * 0.5 + 0.5;
float soapHue = fract(soapSwirlA * 0.68 + soapSwirlB * 0.32 + soapFresnel * 0.22 + uOilTime * 0.0018);
vec3 soapTint = soapSpectrum(soapHue);
float soapAmount = (0.04 + 0.3 * soapFresnel) * (0.48 + 0.22 * soapSwirlB);
gl_FragColor.rgb += soapTint * soapAmount * 0.7;
`)},t.customProgramCacheKey=()=>"soap-film-oily-v1",t.needsUpdate=!0,{material:t,oilTimeUniform:e}}}function ye(o){return new ge(o)}const wt=document.querySelector("#app-canvas");if(!wt)throw new Error("Canvas element #app-canvas was not found.");const be=ye(wt);Object.assign(window,{soapFilmApp:be});
